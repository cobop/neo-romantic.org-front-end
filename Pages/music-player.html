<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Music Player | NRR Music</title>
    <link rel="stylesheet" href="../css/styles.css">
    <link rel="stylesheet" href="../css/responsive.css">
    <link rel="icon" href="../assets/Images/favicon.png" type="image/png">
     
</head>
<body>
    <!-- Header Section -->
    <header class="main-header">
        <div class="container">
            <div class="logo">
                <img src="../assets/Images/NRRLogo.png" alt="NRR Logo" width="40" height="40">
                <h1>NRR Music</h1>
            </div>
            <nav class="main-nav">
                <ul>
                    <li><a href="index.html">Home</a></li>
                    <li><a href="albums.html">Albums</a></li>
                    <li><a href="music-player.html" class="active">Player</a></li>
                    <li><a href="store.html">Store</a></li>
                    <li><a href="subscription.html">Subscription</a></li>
                    <li><a href="instruments.html">Instruments</a></li>
                </ul>
            </nav>
            <div class="user-controls">
                <button class="search-btn">üîç</button>
                <button class="login-btn">Login</button>
            </div>
        </div>
    </header>

    <!-- Player Hero -->
    <section class="hero">
        <div class="container">
            <h2>Music Player</h2>
            <p>Enjoy your favorite tracks with our premium player</p>
        </div>
    </section>

    <!-- Player Interface -->
    <section class="featured-section">
        <div class="container">
            <div class="player-container">
                <!-- Album Art -->
                <div class="player-album-art">
                    <img id="now-playing-cover" src="" alt="Now Playing">
                </div>
                
                <!-- Track Info -->
                <div class="player-track-info">
                    <h2 id="now-playing-title">Track Title</h2>
                    <p class="artist" id="now-playing-artist">Artist Name</p>
                    <p class="album" id="now-playing-album">Album Title</p>
                </div>
                
                <!-- Progress Bar -->
                <div class="player-progress">
                    <span class="current-time" id="current-time">1:23</span>
                    <div class="progress-bar">
                        <div class="progress" id="progress-bar"></div>
                    </div>
                    <span class="total-time" id="total-time">3:45</span>
                </div>
                
                <!-- Controls -->
                <div class="player-controls">
                    <button class="control-btn" id="prev-btn">‚èÆÔ∏è</button>
                    <button class="control-btn play-btn" id="play-btn">‚ñ∂Ô∏è</button>
                    <button class="control-btn" id="next-btn">‚è≠Ô∏è</button>
                </div>
                
                <!-- Volume Control -->
                <div class="player-volume">
                    <button class="control-btn" id="volume-btn">üîà</button>
                    <div class="volume-slider">
                        <div class="volume-level" id="volume-level"></div>
                    </div>
                </div>
            </div>
            
            <!-- Playlist -->
            <div class="playlist">
                <h3>Playlist</h3>
                <div id="playlist-items" class="playlist-items">
                    <!-- Playlist items will be populated by JavaScript -->
                </div>
            </div>
        </div>
    </section>
    
    <script>
        // Minimal client that uses the C++ back‚Äëend API
        let currentAudio = null;
        let isPlaying = false;
        let currentAlbumId = null;
        let currentTrackIndex = 0;

        // Helper to format time strings (e.g., "3:45")
        function formatTime(sec) {
            const m = Math.floor(sec / 60);
            const s = Math.floor(sec % 60);
            return m + ':' + (s < 10 ? '0' + s : s);
        }

        // Load album list from back‚Äëend
        async function loadAlbums() {
            const resp = await fetch('https://localhost:8450/api/albums');
            if (!resp.ok) {
                console.error('Failed to fetch albums');
                return [];
            }
            return await resp.json(); // [{id,title,artist,cover,...}]
        }

        // Load tracks for a given album
        async function loadTracks(albumId) {
            const resp = await fetch(`https://localhost:8450/api/albums/${encodeURIComponent(albumId)}/tracks`);
            if (!resp.ok) {
                console.error('Failed to fetch tracks for', albumId);
                return [];
            }
            return await resp.json(); // array of track objects
        }

        // Populate playlist UI
        async function populatePlaylist(albumId) {
            const tracks = await loadTracks(albumId);
            const playlistContainer = document.getElementById('playlist-items');
            playlistContainer.innerHTML = '';
            tracks.forEach((track, idx) => {
                const item = document.createElement('div');
                item.className = 'playlist-item';
                if (idx === 0) item.classList.add('active');
                item.innerHTML = `
                    <div class="track-number">${track.number}</div>
                    <div class="track-title">${track.title}</div>
                    <div class="track-duration">${track.duration}</div>
                `;
                item.addEventListener('click', () => playTrack(idx));
                playlistContainer.appendChild(item);
            });
        }

        // Update UI for currently playing track
        function updateNowPlaying(track) {
            document.getElementById('now-playing-title').textContent = track.title;
            document.getElementById('now-playing-artist').textContent = track.artist || '';
            document.getElementById('now-playing-album').textContent = track.album || '';
            document.getElementById('now-playing-cover').src = track.cover || '';
        }

        // Highlight active playlist item
        function highlightTrack(idx) {
            const items = document.querySelectorAll('.playlist-item');
            items.forEach((el, i) => {
                if (i === idx) el.classList.add('active');
                else el.classList.remove('active');
            });
        }

        // Play a specific track index
        async function playTrack(index) {
            if (!currentAlbumId) return;
            const tracks = await loadTracks(currentAlbumId);
            if (index < 0 || index >= tracks.length) return;
            const track = tracks[index];
            const streamUrl = `https://localhost:8450/api/stream/${encodeURIComponent(currentAlbumId)}/${track.number}`;
            if (currentAudio) currentAudio.pause();
            currentAudio = new Audio(streamUrl);
            currentAudio.addEventListener('canplay', () => {
                currentAudio.play().catch(e => console.error('Play error', e));
            });
            currentAudio.addEventListener('error', (e) => {
                console.error('Audio error', e);
                alert('Failed to play track. See console for details.');
            });
            currentAudio.addEventListener('timeupdate', () => {
                const cur = currentAudio.currentTime;
                const dur = currentAudio.duration || 0;
                document.getElementById('current-time').textContent = formatTime(cur);
                document.getElementById('total-time').textContent = isNaN(dur) ? '' : formatTime(dur);
                const prog = (cur / dur) * 100;
                document.getElementById('progress-bar').style.width = prog + '%';
            });
            currentAudio.addEventListener('ended', nextTrack);
            updateNowPlaying(track);
            highlightTrack(index);
            currentTrackIndex = index;
            isPlaying = true;
            document.getElementById('play-btn').textContent = '‚è∏Ô∏è';
        }

        // Play/pause toggle
        function togglePlayPause() {
            if (!currentAudio) return;
            if (isPlaying) {
                currentAudio.pause();
                document.getElementById('play-btn').textContent = '‚ñ∂Ô∏è';
            } else {
                currentAudio.play().catch(e => console.error('Play error', e));
                document.getElementById('play-btn').textContent = '‚è∏Ô∏è';
            }
            isPlaying = !isPlaying;
        }

        // Next / previous track navigation
        function nextTrack() {
            const nextIdx = (currentTrackIndex + 1) % (document.querySelectorAll('.playlist-item').length);
            playTrack(nextIdx);
        }
        function prevTrack() {
            const prevIdx = (currentTrackIndex - 1 + document.querySelectorAll('.playlist-item').length) % document.querySelectorAll('.playlist-item').length;
            playTrack(prevIdx);
        }

        // Initialise player UI
        async function initPlayer() {
            const albums = await loadAlbums();
            if (albums.length === 0) return;
            // Choose first album by default
            currentAlbumId = albums[0].id;
            // Update cover/metadata if needed
            document.getElementById('now-playing-cover').src = albums[0].cover || '';
            // Populate playlist
            await populatePlaylist(currentAlbumId);
            // Set up controls
            document.getElementById('play-btn').addEventListener('click', togglePlayPause);
            document.getElementById('next-btn').addEventListener('click', nextTrack);
            document.getElementById('prev-btn').addEventListener('click', prevTrack);
            // Auto‚Äëplay first track
            await playTrack(0);
        }

        window.onload = initPlayer;
    </script>

    <!-- Free vs Paid Section -->
    <section class="free-paid-section">
        <div class="container">
            <h2>Choose Your Experience</h2>
            <div class="pricing-tiers">
                <div class="pricing-card">
                    <h3>Free Stream</h3>
                    <p>MP3 Quality</p>
                    <ul>
                        <li>üéµ Unlimited streaming</li>
                        <li>üì± Mobile friendly</li>
                        <li>üéß Basic player</li>
                    </ul>
                    <button class="btn primary">Start Free</button>
                </div>
                
                <div class="pricing-card popular">
                    <h3>Premium WAV</h3>
                    <p>High Quality Audio</p>
                    <ul>
                        <li>üîä Lossless quality</li>
                        <li>üíæ Downloadable</li>
                        <li>üéÅ Exclusive content</li>
                    </ul>
                    <button class="btn secondary">Buy WAV</button>
                </div>
                
                <div class="pricing-card">
                    <h3>Subscription</h3>
                    <p>Early Access</p>
                    <ul>
                        <li>üÜï Unreleased tracks</li>
                        <li>üéß Early downloads</li>
                        <li>üéâ Member perks</li>
                    </ul>
                    <button class="btn tertiary">Join Now</button>
                </div>
            </div>
        </div>
    </section>

    <!-- Footer -->
    <footer class="main-footer">
        <div class="container">
            <div class="footer-content">
                <div class="footer-logo">
                    <img src="../assets/Images/NRRLogo.png" alt="NRR Logo" width="30" height="30">
                    <h3>NRR Music</h3>
                </div>
                <div class="footer-links">
                    <ul>
                        <li><a href="index.html">Home</a></li>
                        <li><a href="albums.html">Albums</a></li>
                        <li><a href="store.html">Store</a></li>
                        <li><a href="subscription.html">Subscription</a></li>
                        <li><a href="instruments.html">Instruments</a></li>
                    </ul>
                </div>
                <div class="footer-social">
                    <a href="#">FB</a>
                    <a href="#">IG</a>
                    <a href="#">YT</a>
                </div>
            </div>
            <div class="footer-bottom">
                <p>&copy; 2024 NRR Music. All rights reserved.</p>
            </div>
        </div>
    </footer>
</body>
</html>
